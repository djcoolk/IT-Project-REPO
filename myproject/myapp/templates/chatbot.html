{% extends "main.html" %}
{% load static %}

{% block title %}WellnessWhisper Chatbot{% endblock %}

{% block content %}
<div class="chat-page-wrapper d-flex justify-content-center align-items-center vh-100" style="background-color: #f8f9fa;">
    <div class="chat-interface shadow-lg rounded d-flex flex-column" style="width: 100%; max-width: 750px; height: 80vh;">
        <!-- Header -->
        <div class="chat-header text-white text-center" style="background-color: #4a63e7; padding: 15px; font-size: 1.5rem;">
            ðŸŒ± WellnessWhisper Chatbot
        </div>

        <!-- Chatbox -->
        <div class="chatbox p-3 flex-grow-1 overflow-auto" id="chatbox" style="background-color: #f4f4f9;">
            <!-- Initial bot message -->
            <div class="bot-message mb-3" style="background-color: #e6e7ea; color: #333; border-radius: 16px; padding: 12px 16px; max-width: 75%; margin-bottom: 12px;">
                Hi! I'm here to help with any questions you have about mental health.
            </div>
        </div>

        <!-- Input Section -->
        <div class="input-section d-flex p-3" style="border-top: 1px solid #ddd; background-color: #f8f9fa;">
            <form id="chat-form" method="post" class="d-flex w-100" style="align-items: center;">
                {% csrf_token %}
                <input type="text" id="user-input" placeholder="Type your message..." required class="form-control mr-2" style="flex: 1; border-radius: 20px; border: 1px solid #ddd; padding: 10px 15px;">
                <button type="submit" class="btn btn-primary" style="border-radius: 20px; background-color: #4a63e7; padding: 8px 18px;">Send</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    /* Container reset */
    .chat-page-wrapper {
        background-color: #f8f9fa !important;
    }

    .chat-interface {
        display: flex;
        flex-direction: column;
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.2);
    }

    /* Chat Messages */
    .user-message, .bot-message {
        margin-bottom: 12px;
        padding: 12px 16px;
        border-radius: 16px;
        max-width: 75%;
        font-size: 1rem;
        line-height: 1.4;
    }

    .user-message {
        background-color: #4a63e7;
        color: #fff;
        align-self: flex-end;
        text-align: left;
    }

    .bot-message {
        background-color: #e6e7ea;
        color: #333;
        align-self: flex-start;
        text-align: left;
    }

    /* Override form styles */
    .input-section input[type="text"] {
        padding: 10px 15px;
        font-size: 1rem;
        border-radius: 20px;
        border: 1px solid #ddd;
    }

    .input-section button {
        background-color: #4a63e7;
        color: #fff;
        padding: 8px 18px;
        border: none;
        border-radius: 20px;
        font-size: 1rem;
        cursor: pointer;
    }

    .input-section button:hover {
        background-color: #3746ad;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    document.getElementById('chat-form').onsubmit = async (e) => {
        e.preventDefault();
        const userInput = document.getElementById('user-input').value;
        if (!userInput) return;

        // Append user message to chatbox
        const chatbox = document.getElementById("chatbox");
        const userMessage = document.createElement("div");
        userMessage.className = "user-message";
        userMessage.textContent = userInput;
        chatbox.appendChild(userMessage);
        document.getElementById("user-input").value = "";

        try {
            const response = await fetch('/chatbot_response/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({ message: userInput })
            });

            const data = await response.json();

            // Display bot response in chatbox
            const botMessage = document.createElement("div");
            botMessage.className = "bot-message";
            botMessage.textContent = data.response || "I'm sorry, I didn't understand that.";
            chatbox.appendChild(botMessage);

            // Scroll chatbox to the bottom
            chatbox.scrollTop = chatbox.scrollHeight;

        } catch (error) {
            console.error("Error fetching response:", error);
            const errorMessage = document.createElement("div");
            errorMessage.className = "bot-message";
            errorMessage.textContent = "Sorry, I encountered an error. Please try again later.";
            chatbox.appendChild(errorMessage);
        }
    };
</script>
{% endblock %}
